<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="点九编辑器">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>点九编辑器 Pro Max</title>
    <style>
        :root {
            --stretch-color: #3498db; --content-color: #2ecc71; --bg-color: #f0f2f5;
            --panel-color: #ffffff; --text-color: #333; --touch-threshold: 22px;
        }
        * { box-sizing: border-box; }
        html, body { overscroll-behavior: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0;
            display: flex; flex-direction: column; 
            height: 100dvh; 
            overflow: hidden;
        }
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; /* Changed to column */
            justify-content: center; align-items: center;
            overflow: hidden; background-color: #7f8c8d; position: relative;
        }
        #editor-status {
            color: white; background-color: rgba(0,0,0,0.4); padding: 5px 10px;
            border-radius: 8px; font-size: 12px; margin-bottom: 10px;
            display: none; /* Initially hidden */
        }
        #canvas-wrapper { position: relative; touch-action: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        canvas {
            display: block;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .bottom-section {
            background-color: var(--bg-color); padding-top: 10px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05); flex-shrink: 0; overflow-y: auto; 
            max-height: 50%; /* Allow more space for controls on small screens */
            padding-bottom: env(safe-area-inset-bottom);
        }
        .info-panel {
            background-color: var(--panel-color); margin: 0 10px 10px 10px;
            padding: 8px 15px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .info-section h4 { margin: 5px 0; font-size: 14px; font-weight: 600; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 2px 10px; font-size: 13px; }
        .info-grid-item { display: flex; justify-content: space-between; align-items: center; }
        .info-grid-item .label { color: #666; }
        .info-grid-item .value { font-weight: 500; color: var(--text-color); }
        .control-panel { background-color: var(--panel-color); padding: 10px; border-top: 1px solid #eee; }
        .actions-wrapper { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; gap: 10px; }
        .actions button, .actions label { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 12px; color: #555; padding: 5px; border-radius: 8px; width: 65px; text-align: center; cursor: pointer; }
        .actions button:disabled { color: #ccc; cursor: not-allowed; }
        .actions svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .file-inputs { display: flex; gap: 10px; }
        #ai-file-input, #user-file-input { display: none; }
        #placeholder { color: #aaa; text-align: center; }
        
        /* Modal and Preview styles are unchanged, they are correct */
        #preview-window { display: none; position: fixed; bottom: 20px; right: 20px; width: 90%; max-width: 320px; background-color: var(--panel-color); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; }
        #preview-window-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; }
        #preview-window-header h3 { margin: 0; font-size: 16px; }
        #preview-close-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; padding: 0 5px; }
        #preview-window .content { padding: 15px; }
        #preview-container { display: flex; justify-content: center; align-items: center; min-height: 150px; margin-bottom: 15px; background-color: var(--bg-color); border-radius: 8px; overflow: auto; }
        #preview-box { position: relative; flex-shrink: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; }
        .modal-content h3 { margin-top: 0; text-align: center; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .modal-actions button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .modal-actions .btn-primary { background-color: #2ecc71; color: white; }
        .modal-actions .btn-secondary { background-color: #3498db; color: white; }
        #modal-close-btn { background-color: #e74c3c; color: white; margin-top: 10px; }

    </style>
</head>
<body>
    <div class="main-content">
        <div id="editor-status"></div>
        <div id="canvas-wrapper"><canvas id="editor-canvas"></canvas></div>
        <div id="placeholder"><h2>请选择图片</h2><p>点击下方按钮开始</p></div>
    </div>

    <div class="bottom-section">
        <div class="info-panel" id="info-panel" style="display: none;"></div>
        <div class="control-panel">
            <div class="actions-wrapper">
                <div class="actions file-inputs">
                    <label for="ai-file-input">
                        <svg viewBox="0 0 24 24" fill="#2ecc71" stroke="#fff" stroke-width="1"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
                        打开 AI (左)
                    </label>
                    <input type="file" id="ai-file-input" accept="image/*" data-side="ai">
                    <label for="user-file-input">
                         <svg viewBox="0 0 24 24" fill="#3498db" stroke="#fff" stroke-width="1"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
                        打开 User (右)
                    </label>
                    <input type="file" id="user-file-input" accept="image/*" data-side="user">
                </div>
                <div class="actions">
                    <button id="clear-btn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        重置
                    </button>
                    <button id="download-trigger-btn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        下载
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="download-modal" class="modal"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('editor-canvas'); const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('placeholder'); const infoPanel = document.getElementById('info-panel');
        const modal = document.getElementById('download-modal');
        const editorStatus = document.getElementById('editor-status');
        
        // ✨ State management is now object-based ✨
        const state = {
            ai: { image: null, regions: {}, fileName: '', domId: 'ai' },
            user: { image: null, regions: {}, fileName: '', domId: 'user' }
        };
        let activeSide = null; // 'ai' or 'user'

        // Dynamic HTML Injection
        modal.innerHTML = `<div class="modal-content"><h3>下载选项</h3><p>请为 AI 和 User 气泡分别提供公开URL链接。</p><div class="input-group"><label for="ai-url-input">AI (左) 图片 URL:</label><input type="url" id="ai-url-input" placeholder="https://.../ai_image.png"></div><div class="input-group"><label for="user-url-input">User (右) 图片 URL:</label><input type="url" id="user-url-input" placeholder="https://.../user_image.png"></div><div class="modal-actions"><button id="download-css-btn" class="btn-primary">下载组合样式 (.css)</button><button id="modal-close-btn">取消</button></div></div>`;
        infoPanel.innerHTML = `<div class="info-section"><div class="info-grid"><div class="info-grid-item"><span class="label">图像:</span><span class="value" id="img-side"></span></div><div class="info-grid-item"><span class="label">尺寸:</span><span class="value" id="img-size"></span></div></div></div><div class="info-section"><h4>拉伸区域 (px)</h4><div class="info-grid"><div class="info-grid-item"><span class="label">左:</span><span class="value" id="stretch-left"></span></div><div class="info-grid-item"><span class="label">右:</span><span class="value" id="stretch-right"></span></div><div class="info-grid-item"><span class="label">上:</span><span class="value" id="stretch-top"></span></div><div class="info-grid-item"><span class="label">下:</span><span class="value" id="stretch-bottom"></span></div></div></div><div class="info-section"><h4>内容区域 (px)</h4><div class="info-grid"><div class="info-grid-item"><span class="label">左:</span><span class="value" id="content-left"></span></div><div class="info-grid-item"><span class="label">右:</span><span class="value" id="content-right"></span></div><div class="info-grid-item"><span class="label">上:</span><span class="value" id="content-top"></span></div><div class="info-grid-item"><span class="label">下:</span><span class="value" id="content-bottom"></span></div></div></div>`;

        let isDragging = false, draggingLine = null, scale = 1;
        const TOUCH_THRESHOLD = 22;

        function init() {
            document.getElementById('ai-file-input').addEventListener('change', handleFileSelect);
            document.getElementById('user-file-input').addEventListener('change', handleFileSelect);
            document.getElementById('clear-btn').addEventListener('click', () => { if (!activeSide) return; resetRegions(activeSide); redrawAll(); updateInfoPanel(); });
            document.getElementById('download-trigger-btn').addEventListener('click', () => modal.style.display = 'flex');
            document.getElementById('modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
            document.getElementById('download-css-btn').addEventListener('click', downloadCombinedCss);

            const wrapper = document.getElementById('canvas-wrapper');
            ['mousedown', 'touchstart'].forEach(e => wrapper.addEventListener(e, onDown, { passive: false }));
            window.addEventListener('mousemove', onMove, { passive: false });
            window.addEventListener('touchmove', onMove, { passive: false, capture: true });
            ['mouseup', 'touchend', 'touchcancel'].forEach(e => window.addEventListener(e, onUp, { passive: false }));
        }
        
        function handleFileSelect(e) {
            const side = e.target.dataset.side;
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image();
                img.onload = () => {
                    activeSide = side;
                    state[side].image = img;
                    state[side].fileName = file.name;
                    
                    placeholder.style.display = 'none';
                    canvas.style.display = 'block';
                    editorStatus.style.display = 'block';
                    
                    setupCanvas(img);
                    resetRegions(side);
                    redrawAll();
                    updateInfoPanel();
                    
                    infoPanel.style.display = 'block';
                    document.getElementById('clear-btn').disabled = false;
                    if (state.ai.image || state.user.image) {
                        document.getElementById('download-trigger-btn').disabled = false;
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupCanvas(image) { canvas.width = image.width; canvas.height = image.height; }
        
        function resetRegions(side) {
            const { width: w, height: h } = state[side].image;
            state[side].regions = {
                stretch: { top: h * 0.25, bottom: h * 0.75, left: w * 0.25, right: w * 0.75 },
                content: { top: h * 0.25, bottom: h * 0.75, left: w * 0.25, right: w * 0.75 }
            };
        }

        function redrawAll() {
            if (!activeSide || !state[activeSide].image) return;
            const image = state[activeSide].image;
            const mainContent = document.querySelector('.main-content');
            const ratioX = mainContent.clientWidth / image.width;
            const ratioY = (mainContent.clientHeight - editorStatus.offsetHeight - 20) / image.height;
            scale = Math.min(ratioX, ratioY) * 0.9;
            canvas.style.transform = `scale(${scale})`;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0);
            drawGuideLines();
        }

        function drawGuideLines() {
            const r = state[activeSide].regions.stretch;
            const c = state[activeSide].regions.content;
            
            ctx.setLineDash([4 / scale, 3 / scale]);
            // Draw stretch lines (blue)
            ctx.strokeStyle = 'var(--stretch-color)'; ctx.lineWidth = 1 / scale;
            ctx.strokeRect(r.left, r.top, r.right - r.left, r.bottom - r.top);
            // Draw content lines (green)
            ctx.strokeStyle = 'var(--content-color)'; ctx.lineWidth = 2 / scale; // Thicker for visibility
            ctx.strokeRect(c.left, c.top, c.right - c.left, c.bottom - c.top);
            
            ctx.setLineDash([]);
        }

        function getEventPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / scale, y: (clientY - rect.top) / scale };
        }

        function onDown(e) {
            if (!activeSide) return;
            e.preventDefault();
            const pos = getEventPos(e);
            const r = state[activeSide].regions.stretch;
            const threshold = TOUCH_THRESHOLD / scale;
            
            const dists = {
                top: Math.abs(pos.y - r.top), bottom: Math.abs(pos.y - r.bottom),
                left: Math.abs(pos.x - r.left), right: Math.abs(pos.x - r.right),
            };
            
            let min_dist = Infinity; let closest_line = null;
            for (const [line, dist] of Object.entries(dists)) {
                if (dist < min_dist) { min_dist = dist; closest_line = line; }
            }
            if (min_dist < threshold) { isDragging = true; draggingLine = closest_line; }
        }

        function onMove(e) {
            if (!isDragging || !draggingLine) return;
            e.preventDefault();
            const pos = getEventPos(e);
            const r = state[activeSide].regions.stretch;
            const { width: w, height: h } = state[activeSide].image;
            
            if (draggingLine === 'top') r.top = Math.max(0, Math.min(pos.y, r.bottom));
            else if (draggingLine === 'bottom') r.bottom = Math.min(h, Math.max(pos.y, r.top));
            else if (draggingLine === 'left') r.left = Math.max(0, Math.min(pos.x, r.right));
            else if (draggingLine === 'right') r.right = Math.min(w, Math.max(pos.x, r.left));
            
            // Auto-update content region to stay inside stretch region
            const c = state[activeSide].regions.content;
            c.top = Math.max(c.top, r.top);
            c.bottom = Math.min(c.bottom, r.bottom);
            c.left = Math.max(c.left, r.left);
            c.right = Math.min(c.right, r.right);

            redrawAll();
            updateInfoPanel();
        }

        function onUp() { isDragging = false; draggingLine = null; }

        function updateInfoPanel() {
            if (!activeSide) return;
            const { image, regions: r, fileName } = state[activeSide];
            editorStatus.textContent = `正在编辑: ${side === 'ai' ? 'AI (左)' : 'User (右)'} - ${fileName}`;
            document.getElementById('img-side').textContent = `${activeSide === 'ai' ? 'AI (左)' : 'User (右)'}`;
            document.getElementById('img-size').textContent = `${image.width} x ${image.height} px`;
            
            ['top', 'bottom', 'left', 'right'].forEach(line => {
                document.getElementById(`stretch-${line}`).textContent = Math.round(r.stretch[line]);
                document.getElementById(`content-${line}`).textContent = Math.round(r.content[line]);
            });
        }
        
        function generateCssForSide(side, imageUrl) {
            const s = state[side];
            if (!s.image) return '';

            const { width: w, height: h } = s.image;
            const sr = s.regions.stretch;
            const cr = s.regions.content;

            const slice = {
                top: Math.round(sr.top), right: Math.round(w - sr.right),
                bottom: Math.round(h - sr.bottom), left: Math.round(sr.left)
            };
            const scaleFactor = Math.max(1, Math.round(Math.min(w, h) / 150));
            const borderWidth = {
                top: Math.round(slice.top / scaleFactor), right: Math.round(slice.right / scaleFactor),
                bottom: Math.round(slice.bottom / scaleFactor), left: Math.round(slice.left / scaleFactor)
            };
            const padding = {
                top: Math.round(cr.top / scaleFactor), right: Math.round((w - cr.right) / scaleFactor),
                bottom: Math.round((h - cr.bottom) / scaleFactor), left: Math.round(cr.left / scaleFactor)
            };

            const bubbleClass = side === 'ai' ? '.message-bubble.ai' : '.message-bubble.user';
            
            return `
/* --- ${side === 'ai' ? 'AI气泡 (左侧)' : '用户气泡 (右侧)'} --- */
${bubbleClass} .content::before {
    border-image-source: url('${imageUrl}');
    border-image-slice: ${slice.top} ${slice.right} ${slice.bottom} ${slice.left} fill;
    border-image-width: ${borderWidth.top}px ${borderWidth.right}px ${borderWidth.bottom}px ${borderWidth.left}px;
}
${bubbleClass} .content {
    padding: ${padding.top}px ${padding.right}px ${padding.bottom}px ${padding.left}px;
}
`;
        }

        function downloadCombinedCss() {
            const aiUrl = document.getElementById('ai-url-input').value;
            const userUrl = document.getElementById('user-url-input').value;

            if ((state.ai.image && !aiUrl) || (state.user.image && !userUrl)) {
                alert('请为所有已加载的图片提供URL链接！');
                return;
            }

            let css = `/*\n * =======================================================\n *   组合气泡样式 by 点九编辑器 Pro Max\n * =======================================================\n*/\n\n.message-bubble.user .content,\n.message-bubble.ai .content {\n    background: transparent !important; border: none !important; border-radius: 0 !important; box-shadow: none !important; position: relative; z-index: 1;\n}\n\n.message-bubble.user .content::before,\n.message-bubble.ai .content::before {\n    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; border-style: solid;\n}\n`;

            if (state.ai.image) {
                css += generateCssForSide('ai', aiUrl);
            }
            if (state.user.image) {
                css += generateCssForSide('user', userUrl);
            }

            const blob = new Blob([css], { type: 'text/css' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'combined-bubble-style.css';
            link.click();
            URL.revokeObjectURL(link.href);
            modal.style.display = 'none';
        }

        init();
        window.addEventListener('resize', redrawAll);
    });
    </script>
</body>
</html>
