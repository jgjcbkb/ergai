<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 内容修改工具 (V2.0 专业版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background-color: #ffffff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        input[type="file"], input[type="text"], textarea, select { width: 100%; padding: 12px; border: 1px solid #dcdfe6; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input[type="file"] { padding: 8px; }
        textarea { min-height: 150px; resize: vertical; font-family: monospace, sans-serif; }
        input[type="text"]:focus, textarea:focus, select:focus { outline: none; border-color: #409eff; }
        .button-group { display: flex; gap: 15px; margin-top: 25px; }
        button { flex-grow: 1; padding: 12px 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        #modifyButton { background-color: #409eff; color: white; }
        #modifyButton:hover { background-color: #337ecc; }
        #downloadButton { background-color: #67c23a; color: white; }
        #downloadButton:hover { background-color: #529b2e; }
        #downloadButton:disabled { background-color: #c0c4cc; cursor: not-allowed; }
        .message { margin-top: 20px; padding: 12px; border-radius: 6px; text-align: center; font-weight: 500; }
        .message.success { background-color: #f0f9eb; color: #67c23a; border: 1px solid #e1f3d8; }
        .message.error { background-color: #fef0f0; color: #f56c6c; border: 1px solid #fde2e2; }
        .info { font-size: 12px; color: #909399; margin-top: 20px; text-align: center; }
        .flex-group { display: flex; gap: 10px; align-items: center; }
        .flex-group label { flex-shrink: 0; margin-bottom: 0; }
        .flex-group input { width: 80px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML 内容修改工具 (V2.0 专业版)</h1>
        <div class="form-group">
            <label for="htmlFileInput">1. 导入 HTML 文件</label>
            <input type="file" id="htmlFileInput" accept=".html, .htm">
        </div>

        <!-- 全新：模式选择 -->
        <div class="form-group">
            <label for="targetingMode">2. 选择定位模式</label>
            <select id="targetingMode">
                <option value="css">CSS 选择器 (用于修改HTML结构)</option>
                <option value="text">文本/正则表达式 (用于修改任意内容, 包括JS代码)</option>
            </select>
        </div>

        <!-- CSS 选择器模式的字段 -->
        <div id="cssModeFields">
            <div class="form-group">
                <label for="cssSelectorInput">3. 输入目标位置的 CSS 选择器</label>
                <input type="text" id="cssSelectorInput" placeholder="例如: body, .content, #main-title">
            </div>
            <div class="form-group">
                <label for="modificationMode">4. 选择修改模式</label>
                <select id="modificationMode">
                    <option value="append">追加到目标末尾 (Append)</option>
                    <option value="prepend">插入到目标开头 (Prepend)</option>
                    <option value="replace">替换目标内容 (Replace Inner HTML)</option>
                    <option value="before">插入到目标前面 (Insert Before)</option>
                    <option value="after">插入到目标后面 (Insert After)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cssNewContentInput">5. 输入要操作的新内容 (HTML/文本)</label>
                <textarea id="cssNewContentInput" placeholder="在这里输入要添加或替换的 HTML 代码或文本"></textarea>
            </div>
        </div>

        <!-- 文本/正则模式的字段 -->
        <div id="textModeFields" style="display: none;">
            <div class="form-group">
                <label for="findInput">3. 查找内容 (支持正则表达式)</label>
                <textarea id="findInput" placeholder="输入要查找的精确文本或正则表达式"></textarea>
            </div>
            <div class="form-group flex-group">
                <label for="regexFlagsInput">正则标志:</label>
                <input type="text" id="regexFlagsInput" value="g" placeholder="g, s, i...">
                <span class="info" style="margin:0;">(g:全局, s:换行匹配, i:忽略大小写)</span>
            </div>
            <div class="form-group">
                <label for="replaceInput">4. 替换为 (支持 $1, $2 等捕获组)</label>
                <textarea id="replaceInput" placeholder="输入替换后的内容。使用 $1, $2 引用正则表达式中的捕获组。"></textarea>
            </div>
        </div>

        <div class="button-group">
            <button id="modifyButton">执行修改</button>
            <button id="downloadButton" disabled>下载修改后的文件</button>
        </div>
        <div id="messageArea"></div>
        <p class="info">所有操作均在您的浏览器本地完成，文件不会上传至服务器。</p>
    </div>
    <script>
        let modifiedHtmlContent = null;
        let originalFileName = 'modified_file.html';

        const htmlFileInput = document.getElementById('htmlFileInput');
        const targetingMode = document.getElementById('targetingMode');

        // CSS 模式字段
        const cssModeFields = document.getElementById('cssModeFields');
        const cssSelectorInput = document.getElementById('cssSelectorInput');
        const modificationMode = document.getElementById('modificationMode');
        const cssNewContentInput = document.getElementById('cssNewContentInput');

        // 文本模式字段
        const textModeFields = document.getElementById('textModeFields');
        const findInput = document.getElementById('findInput');
        const regexFlagsInput = document.getElementById('regexFlagsInput');
        const replaceInput = document.getElementById('replaceInput');

        const modifyButton = document.getElementById('modifyButton');
        const downloadButton = document.getElementById('downloadButton');
        const messageArea = document.getElementById('messageArea');

        // 切换模式时，显示/隐藏对应的输入框
        targetingMode.addEventListener('change', () => {
            if (targetingMode.value === 'css') {
                cssModeFields.style.display = 'block';
                textModeFields.style.display = 'none';
            } else {
                cssModeFields.style.display = 'none';
                textModeFields.style.display = 'block';
            }
        });

        htmlFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                originalFileName = 'modified_' + file.name;
                modifiedHtmlContent = null; 
                downloadButton.disabled = true;
                messageArea.innerHTML = '';
            }
        });

        modifyButton.addEventListener('click', () => {
            messageArea.innerHTML = '';
            
            const file = htmlFileInput.files[0];
            if (!file && !modifiedHtmlContent) { 
                showMessage('请先选择一个 HTML 文件。', 'error'); 
                return; 
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const baseContent = modifiedHtmlContent || event.target.result;
                try {
                    // 根据选择的模式执行不同逻辑
                    if (targetingMode.value === 'css') {
                        executeCssModification(baseContent);
                    } else {
                        executeTextModification(baseContent);
                    }
                } catch (e) {
                    showMessage(`处理失败：${e.message}`, 'error');
                }
            };
            reader.onerror = () => showMessage('读取文件时发生错误。', 'error');
            
            if (!modifiedHtmlContent) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.onload({ target: { result: modifiedHtmlContent } });
            }
        });

        function executeCssModification(baseContent) {
            const selector = cssSelectorInput.value.trim();
            const mode = modificationMode.value;
            const newContent = cssNewContentInput.value;
            if (!selector) { showMessage('请输入 CSS 选择器。', 'error'); return; }

            const parser = new DOMParser();
            const doc = parser.parseFromString(baseContent, 'text/html');
            const elements = doc.querySelectorAll(selector);

            if (elements.length === 0) {
                showMessage(`未找到匹配 CSS 选择器 "${selector}" 的元素。`, 'error');
                return;
            }

            elements.forEach(element => {
                switch (mode) {
                    case 'append': element.insertAdjacentHTML('beforeend', newContent); break;
                    case 'prepend': element.insertAdjacentHTML('afterbegin', newContent); break;
                    case 'replace': element.innerHTML = newContent; break;
                    case 'before': element.insertAdjacentHTML('beforebegin', newContent); break;
                    case 'after': element.insertAdjacentHTML('afterend', newContent); break;
                }
            });
            
            modifiedHtmlContent = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
            showMessage(`成功对 ${elements.length} 个元素执行了 [${mode}] 操作！可以再次修改或下载。`, 'success');
            downloadButton.disabled = false;
        }

        function executeTextModification(baseContent) {
            const findValue = findInput.value;
            const flags = regexFlagsInput.value.trim();
            const replaceValue = replaceInput.value;
            if (!findValue) { showMessage('请输入要查找的内容。', 'error'); return; }

            try {
                const regex = new RegExp(findValue, flags);
                const matches = baseContent.match(regex);
                const matchCount = matches ? matches.length : 0;

                if (matchCount === 0) {
                    showMessage('未找到任何匹配项。', 'error');
                    return;
                }

                modifiedHtmlContent = baseContent.replace(regex, replaceValue);
                showMessage(`成功替换了 ${matchCount} 处匹配项！可以再次修改或下载。`, 'success');
                downloadButton.disabled = false;

            } catch (e) {
                showMessage(`正则表达式错误：${e.message}`, 'error');
            }
        }

        downloadButton.addEventListener('click', () => {
            if (!modifiedHtmlContent) return;
            const blob = new Blob([modifiedHtmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = originalFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        });

        function showMessage(text, type) {
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
    </script>
</body>
</html>
